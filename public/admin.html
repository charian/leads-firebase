// functions/index.js
// Firebase Functions v2 (HTTPS)

const { onRequest, onCall, HttpsError } = require("firebase-functions/v2/https");
const { setGlobalOptions } = require("firebase-functions/v2");
const admin = require("firebase-admin");
const { getFirestore, FieldValue } = require("firebase-admin/firestore");

/* ===== Global options ===== */
setGlobalOptions({ region: "asia-northeast3" });

/* ===== Admin SDK ===== */
admin.initializeApp();

/* ===== Constants ===== */
const DB_NAME = "customer-database";   // 보조 Firestore DB ID
const LEADS = "leads";

// 허용 Origin (정확일치 + 패턴)
const ALLOWED_ORIGINS = [
  "https://holistic-learning-739071.framer.app",
  "https://urology01.planplant.io",
  "http://localhost:5173",
];
const ALLOWED_PATTERNS = [
  /^https:\/\/urology\d+\.planplant\.io$/,
];

/* ===== Helpers ===== */
function isAllowedOrigin(origin) {
  if (!origin) return false;
  if (ALLOWED_ORIGINS.includes(origin)) return true;
  return ALLOWED_PATTERNS.some((re) => re.test(origin));
}

// 프리플라이트/본요청 공통 CORS 세팅
function setCors(req, res) {
  const origin = req.headers.origin || "";
  const reqHeaders = req.headers["access-control-request-headers"] || "Content-Type";
  const allowed = isAllowedOrigin(origin);

  if (allowed) res.set("Access-Control-Allow-Origin", origin);
  // 사전요청에 응답하기 위해 Vary를 정확히 설정
  res.set("Vary", "Origin, Access-Control-Request-Headers");
  res.set("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.set("Access-Control-Allow-Headers", reqHeaders);

  return allowed;
}

// 한국 전화번호 → E.164(+82…) 간이 정규화
function normalizePhoneKR(raw) {
  if (!raw) return "";
  let digits = String(raw).replace(/\D/g, "");
  if (digits.startsWith("0")) digits = digits.slice(1);
  if (!digits.startsWith("82")) digits = "82" + digits;
  return "+" + digits;
}

// 지역값 정규화
function normalizeRegion(input) {
  const v = String(input || "").trim();
  if (v === "수도권" || v.toLowerCase() === "metro") return { ko: "수도권", key: "metro" };
  if (v === "비수도권" || ["non_metro", "non-metro"].includes(v.toLowerCase()))
    return { ko: "비수도권", key: "non_metro" };
  return null;
}

/* ===== Firestore (secondary DB) =====
   기본 DB를 쓰려면 다음으로 바꿔도 됨: getFirestore()
*/
const db = getFirestore(undefined, DB_NAME);

/* ===== Handlers ===== */

// 1) 헬스 체크
exports.ping = onRequest((_, res) => res.status(200).send("pong"));

// 2) 리드 생성 (HTTP)
exports.createLead = onRequest(async (req, res) => {
  const allowed = setCors(req, res);

  // Preflight
  if (req.method === "OPTIONS") return res.status(204).send("");

  // 브라우저 요청(Origin 존재)일 때만 화이트리스트 강제
  if (req.headers.origin && !allowed) {
    return res.status(403).json({ error: "Forbidden origin" });
  }

  try {
    if (req.method !== "POST") {
      return res.status(405).json({ error: "Method Not Allowed" });
    }

    const {
      name,
      phone,
      region,
      referrer,
      utm_source,
      utm_medium,
      utm_campaign,
      utm_content,
      utm_term,
      page,
      userAgent,
    } = req.body || {};

    // 필수값
    if (!name || !phone || !region) {
      return res.status(400).json({ error: "name, phone, region are required" });
    }

    // 지역 검증
    const regionInfo = normalizeRegion(region);
    if (!regionInfo) {
      return res.status(400).json({ error: "region must be 수도권 or 비수도권" });
    }

    // 전화번호 E.164 변환 + 포맷 검사
    const phoneE164 = normalizePhoneKR(phone);
    if (!/^\+\d{9,15}$/.test(phoneE164)) {
      return res.status(400).json({ error: "invalid phone" });
    }

    // 중복 체크
    const docRef = db.collection(LEADS).doc(phoneE164);
    const snap = await docRef.get();
    if (snap.exists) {
      return res.status(409).json({ error: "duplicate phone", phone: phoneE164 });
    }

    // 저장
    await docRef.set(
      {
        name: String(name).trim(),
        phone_raw: String(phone).trim(),
        phone_e164: phoneE164,
        region_key: regionInfo.key, // 'metro' | 'non_metro'
        region_ko: regionInfo.ko,   // '수도권' | '비수도권'
        referrer: referrer || req.headers["referer"] || "",
        utm_source: utm_source || "",
        utm_medium: utm_medium || "",
        utm_campaign: utm_campaign || "",
        utm_content: utm_content || "",
        utm_term: utm_term || "",
        page: page || "",
        userAgent: userAgent || req.headers["user-agent"] || "",
        createdAt: FieldValue.serverTimestamp(),
        download: 0,
      },
      { merge: false }
    );

    return res.status(201).json({ ok: true, id: phoneE164 });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ error: "internal", detail: err.message });
  }
});

// 3) 다운로드 카운트 증가 (Callable)
// - Firebase Auth 필요
// - req.data.ids: string[]
exports.incrementDownloads = onCall(async (req) => {
  const uid = req.auth?.uid;
  if (!uid) throw new HttpsError("unauthenticated", "signin required");

  const ids = req.data?.ids;
  if (!Array.isArray(ids) || ids.length === 0) {
    throw new HttpsError("invalid-argument", "ids required");
  }

  const _db = getFirestore(undefined, DB_NAME); // 동일 보조 DB
  const writer = _db.bulkWriter();
  for (const id of ids) {
    const ref = _db.collection(LEADS).doc(String(id));
    writer.update(ref, { download: FieldValue.increment(1) });
  }
  await writer.close();

  return { updated: ids.length };
});
